# Платформа .NET 8: Внутреннее устройство

## 1. Среда выполнения (CLR - Common Language Runtime)
- **Назначение**: Управление выполнением .NET-кода. Включает в себя компиляцию, управление памятью, безопасность типов и т.д.
- **IL (Intermediate Language)**: Весь C# код компилируется не в машинный код, а в промежуточный язык (IL или CIL). Это позволяет коду быть портируемым.
- **JIT-компиляция (Just-In-Time)**: CLR компилирует IL-код в нативный машинный код непосредственно перед его первым выполнением.
  - **Tiered Compilation**: Современный JIT-компилятор использует многоуровневую компиляцию. Сначала метод компилируется быстро, но с минимальными оптимизациями (Tier 0). Если среда выполнения замечает, что метод вызывается очень часто ("горячий" метод), он ставится в очередь на перекомпиляцию с полным набором оптимизаций (Tier 1). Это обеспечивает быстрый запуск приложения и высокую производительность для часто используемого кода.
- **AOT (Ahead-of-Time)**: Компиляция в нативный код во время сборки приложения, а не во время выполнения. Используется, например, в Native AOT для создания самодостаточных исполняемых файлов с быстрым запуском и меньшим потреблением памяти, ценой отказа от некоторых динамических возможностей.

## 2. Сборщик мусора (GC - Garbage Collector)
- **Назначение**: Автоматическое управление памятью, освобождение объектов из кучи, которые больше не используются.
- **Поколения (Generations)**: GC делит кучу на три поколения (Gen 0, 1, 2) на основе "гипотезы о поколениях": большинство объектов умирают молодыми.
  - **Gen 0**: "Детский сад" для новых объектов. Собирается очень часто и быстро.
  - **Gen 1**: Объекты, пережившие сборку в Gen 0. "Промежуточный" буфер.
  - **Gen 2**: Долгоживущие объекты. Сборка этого поколения (Full GC) — дорогая операция, и среда выполнения старается избегать ее.
- **LOH (Large Object Heap)**: Отдельная область кучи для больших объектов (>85KB). Эти объекты не перемещаются (не компактизируются), чтобы избежать высоких накладных расходов на копирование больших блоков памяти. Это может приводить к фрагментации LOH.
- **Режимы работы**:
    - **Workstation GC**: Оптимизирован для клиентских приложений (UI). Имеет низкую задержку, сборка мусора может приостанавливать потоки приложения на короткое время, чтобы не было "зависаний" интерфейса.
    - **Server GC**: Оптимизирован для серверных приложений (ASP.NET Core). Обеспечивает высокую пропускную способность. Создает по одной куче и одному потоку GC для каждого ядра CPU, сборка мусора происходит параллельно.
- **Фазы сборки**: Маркировка (найти все "живые" объекты, следуя по ссылкам от корней GC) -> Очистка (освободить память от "мертвых" объектов) / Компактизация (переместить живые объекты, чтобы убрать фрагментацию).

## 3. Управление памятью
- **Стек (Stack)**: Память для локальных переменных, параметров методов. Работает по принципу LIFO. Память освобождается автоматически при выходе из метода.
  - **`stackalloc`**: Позволяет явно выделять память на стеке, например, для временных массивов, избегая нагрузки на GC.
- **Куча (Heap)**: Память для объектов (экземпляров классов). Управляется сборщиком мусора.
- **Value Types vs. Reference Types**:
  - **Value Types** (`struct`, `int`, `bool`): Хранят свое значение напрямую. Обычно живут на стеке. При присваивании происходит **копирование значения**.
  - **Reference Types** (`class`, `string`, `delegate`): Хранят ссылку на область памяти в куче. При присваивании происходит **копирование ссылки**, но сам объект остается в куче в одном экземпляре.

  ```csharp
  // Reference Type (Class)
  public class MyClass { public int Value; }
  var c1 = new MyClass { Value = 10 };
  var c2 = c1; // Копируется ссылка
  c2.Value = 20;
  // c1.Value теперь тоже 20

  // Value Type (Struct)
  public struct MyStruct { public int Value; }
  var s1 = new MyStruct { Value = 10 };
  var s2 = s1; // Копируется значение
  s2.Value = 20;
  // s1.Value по-прежнему 10
  ```

## 4. Сборки (Assemblies)
- **.dll / .exe**: Основные единицы развертывания, версионирования и безопасности в .NET.
- **Манифест**: Метаданные сборки, которые содержат ее имя, версию, культуру, а также список всех внешних сборок, на которые она ссылается.
- **GAC (Global Assembly Cache)**: Устаревшее глобальное хранилище для сборок в .NET Framework. В современном .NET Core/5+ не используется, зависимости управляются через NuGet и лежат рядом с приложением. 