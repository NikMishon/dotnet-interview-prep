# Active Directory: Основы для разработчика

Active Directory (AD) — это служба каталогов от Microsoft для сетей на базе Windows. Для корпоративного разработчика понимание основ AD критически важно, так как это центральная система для управления пользователями, компьютерами и политиками безопасности в большинстве организаций.

## 1. Что такое Active Directory?

Представьте AD как специализированную базу данных. Но вместо данных о продуктах и заказах, она хранит информацию об объектах в сети:
- **Пользователи (`User`)**: Учетные записи сотрудников.
- **Группы (`Group`)**: Для объединения пользователей и назначения им прав.
- **Компьютеры (`Computer`)**: Рабочие станции и серверы, введенные в домен.
- **Принтеры, файловые шары** и другие ресурсы.

**Ключевая задача AD** — **аутентификация** (проверка, что пользователь — это тот, за кого себя выдает) и **авторизация** (определение, что этому пользователю разрешено делать).

## 2. Основные концепции

- **Домен (Domain)**
  - Это основная логическая единица в AD. Группа объектов (пользователей, компьютеров), которые подчиняются общим правилам и имеют общую базу данных каталога. Например, `mycompany.local`.

- **Контроллер домена (Domain Controller, DC)**
  - Это сервер, на котором запущена служба Active Directory. Он хранит копию базы данных каталога и обрабатывает запросы на аутентификацию и авторизацию. В домене обычно несколько DC для отказоустойчивости.

- **Лес (Forest) и Дерево (Tree)**
  - **Дерево**: Один или несколько доменов, объединенных в иерархическую структуру с общим пространством имен. Например, домен `sales.mycompany.local` может быть в одном дереве с `mycompany.local`.
  - **Лес**: Один или несколько доменов/деревьев, которые не имеют общего пространства имен, но доверяют друг другу. Это самая крупная граница безопасности в AD.

- **Подразделение (Organizational Unit, OU)**
  - Это контейнер внутри домена, который используется для группировки объектов (например, пользователей отдела бухгалтерии) для удобства администрирования. К OU можно применять **групповые политики (Group Policies, GPO)**.

- **Групповые политики (GPO)**
  - Это набор правил и настроек (например, "запретить доступ к панели управления", "установить этот принтер по умолчанию"), которые применяются к пользователям и компьютерам внутри OU.

## 3. Протоколы взаимодействия с AD

### LDAP (Lightweight Directory Access Protocol)
- **Что это?** Стандартный протокол для доступа к службам каталогов и их изменения. AD — это одна из реализаций службы каталогов, совместимая с LDAP.
- **Как работает?** LDAP позволяет выполнять операции CRUD (Create, Read, Update, Delete) над объектами в каталоге.
- **Структура пути (Distinguished Name, DN)**: LDAP использует уникальные имена для идентификации объектов. Например: `CN=John Doe,OU=Users,DC=mycompany,DC=local` (Common Name = John Doe, в OU=Users, в домене mycompany.local).
- **В .NET**: Пространство имен `System.DirectoryServices.Protocols` предоставляет классы для низкоуровневой работы с LDAP.

### Kerberos
- **Что это?** Основной протокол **аутентификации** в Active Directory.
- **Как работает (упрощенно)?**
  1.  **Запрос TGT**: Клиент (пользователь) при входе в систему отправляет свой пароль контроллеру домена (в KDC - Key Distribution Center). Если пароль верный, KDC выдает клиенту специальный "билет на получение билетов" (**Ticket-Granting Ticket, TGT**).
  2.  **Запрос Service Ticket**: Когда клиент хочет получить доступ к ресурсу (например, к файловому серверу), он отправляет свой TGT в KDC и просит "сервисный билет" (**Service Ticket**) для доступа к этому конкретному ресурсу.
  3.  **Доступ к ресурсу**: Клиент предъявляет сервисный билет файловому серверу. Сервер проверяет билет (он зашифрован ключом, который знает только сервер и KDC) и, если все в порядке, предоставляет доступ.
- **Преимущества**: Пароль пользователя не передается по сети при каждом запросе к ресурсу. Используется система доверенных билетов.

### NTLM (NT LAN Manager)
- **Что это?** Устаревший протокол аутентификации (challenge-response), который все еще используется для обратной совместимости. Kerberos является предпочтительным.

## 4. Зачем это разработчику?
- **Интегрированная аутентификация Windows (IWA)**: В корпоративных веб-приложениях (intranet) часто используется IWA. Пользователю не нужно вводить логин/пароль на сайте, браузер автоматически использует его "сессию" в Windows (Kerberos/NTLM) для аутентификации на сервере. В ASP.NET Core это настраивается через `Microsoft.AspNetCore.Authentication.Negotiate`.
- **Авторизация на основе групп**: Ваше приложение может проверять, входит ли пользователь в определенные группы AD, чтобы предоставить ему доступ к той или иной функциональности.
- **Поиск информации о пользователе**: Получение из AD полного имени пользователя, его email, должности, отдела для отображения в приложении. 