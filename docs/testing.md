# Тестирование в .NET

Тестирование — это неотъемлемая часть процесса разработки, которая гарантирует качество, надежность и поддерживаемость кода.

## 1. Виды тестирования (Пирамида тестирования)

- **Unit Tests (Модульные тесты)** - *Основание пирамиды*
  - **Что тестируют**: Самый маленький изолированный "юнит" кода, обычно один метод или класс.
  - **Характеристики**:
    - **Быстрые**: Выполняются за миллисекунды.
    - **Изолированные**: Все внешние зависимости (другие классы, БД, API) должны быть заменены на **заглушки (stubs)** или **моки (mocks)**.
    - **Многочисленные**: Составляют подавляющее большинство тестов в проекте.
  - **Инструменты**: xUnit, NUnit, MSTest.
  - **Библиотеки для моков**: Moq, NSubstitute, FakeItEasy.
  - **Пример (xUnit + Moq)**:
    ```csharp
    public class Calculator
    {
        private readonly ILogger _logger;
        public Calculator(ILogger logger) { _logger = logger; }
        public int Add(int a, int b) 
        {
            _logger.Log($"{a}+{b}");
            return a + b;
        }
    }
    
    [Fact]
    public void Add_ShouldReturnSum_WhenTwoNumbersAreGiven()
    {
        // Arrange
        var loggerMock = new Mock<ILogger>();
        var calculator = new Calculator(loggerMock.Object);
        
        // Act
        var result = calculator.Add(2, 3);
        
        // Assert
        Assert.Equal(5, result);
        // Проверяем, что метод Log был вызван ровно один раз
        loggerMock.Verify(l => l.Log(It.IsAny<string>()), Times.Once);
    }
    ```

- **Integration Tests (Интеграционные тесты)** - *Середина пирамиды*
  - **Что тестируют**: Взаимодействие нескольких компонентов системы между собой. Например, "мой сервис -> база данных" или "мой API -> внешний сервис".
  - **Характеристики**:
    - **Медленнее** юнит-тестов, так как задействуют внешнюю инфраструктуру (БД, файловую систему, сеть).
    - **Не изолированные**: Используют реальные зависимости или их тестовые аналоги (например, тестовую БД в Docker).
    - **Менее многочисленные**, чем юнит-тесты.
  - **Инструменты в ASP.NET Core**: `WebApplicationFactory` и `TestServer`. `WebApplicationFactory` позволяет запустить ваше приложение в памяти для тестирования, включая весь конвейер (middleware, роутинг, DI).
  - **Пример (ASP.NET Core)**:
    ```csharp
    public class ApiIntegrationTests : IClassFixture<WebApplicationFactory<Program>>
    {
        private readonly HttpClient _client;

        public ApiIntegrationTests(WebApplicationFactory<Program> factory)
        {
            _client = factory.CreateClient();
        }

        [Fact]
        public async Task Get_HealthCheck_ShouldReturnOk()
        {
            // Act
            var response = await _client.GetAsync("/health");

            // Assert
            response.EnsureSuccessStatusCode(); // Статус 200-299
            Assert.Equal("text/plain", response.Content.Headers.ContentType.ToString());
        }
    }
    ```

- **End-to-End (E2E) Tests (Сквозные тесты)** - *Верхушка пирамиды*
  - **Что тестируют**: Всю систему целиком, с точки зрения пользователя. Имитируют действия пользователя в браузере или мобильном приложении.
  - **Характеристики**:
    - **Очень медленные**: Требуют развернутого окружения и запуска UI.
    - **Хрупкие**: Могут ломаться из-за незначительных изменений в UI.
    - **Малочисленные**: Их должно быть немного, они покрывают только самые критичные пользовательские сценарии.
  - **Инструменты**: Selenium, Playwright, Cypress.

## 2. Test-Driven Development (TDD)
- **Что это**: Техника разработки, при которой тесты пишутся **до** написания самого кода.
- **Цикл "Красный-Зеленый-Рефакторинг"**:
  1. **Красный**: Написать падающий тест, который описывает желаемую функциональность.
  2. **Зеленый**: Написать **минимально необходимый** код, чтобы тест прошел.
  3. **Рефакторинг**: Улучшить код, сохраняя прохождение теста.
- **Преимущества**:
  - Улучшает дизайн кода (код, который легко тестировать, обычно хорошо спроектирован).
  - Гарантирует 100% покрытие кода тестами.
  - Служит живой документацией.

## 3. Принципы хороших тестов (FIRST)
- **Fast (Быстрые)**: Тесты должны выполняться быстро.
- **Independent/Isolated (Независимые/Изолированные)**: Тесты не должны зависеть друг от друга. Порядок их выполнения не должен иметь значения.
- **Repeatable (Повторяемые)**: Тест должен давать одинаковый результат при каждом запуске в любом окружении.
- **Self-Validating (Самопроверяемые)**: Тест должен сам определять, прошел он или нет (через `Assert`). Не должно требоваться ручной проверки результатов.
- **Timely (Своевременные)**: Тесты должны писаться вовремя (в идеале, до кода, как в TDD).

## 4. .NET Aspire

- **Что это?** .NET Aspire — это новый (начиная с .NET 8) стек для создания облачных (cloud-native) распределенных приложений.
- **Какое отношение имеет к тестированию?**
  - Aspire значительно **упрощает написание интеграционных тестов** для распределенных систем.
  - Он позволяет легко запустить ваше приложение и все его зависимости (базы данных, брокеры сообщений типа RabbitMQ, кэш Redis) в виде Docker-контейнеров прямо из кода вашего теста.
  - Aspire предоставляет утилиты для работы с этими ресурсами: получение строк подключения, очистка базы данных между тестами и т.д.
  - Это избавляет от необходимости вручную настраивать сложную тестовую среду и делает интеграционное тестирование более доступным и надежным. 